# Terraform AWS & K3s Lab (Separated)

The project is split into two parts to avoid state dependency hell:
1. **Infra**: AWS Resources (VPC, EC2, S3, RDS, Cognito)
2. **Apps**: Kubernetes Resources (Deployments, Services, Ingress)

## Prerequisites
ssh-keygen -t ed25519 -f .ssh/terraform-lab -N ""

## Step 1: Provision AWS Infrastructure
```bash
# Init and Apply Infra
docker compose run --rm -w /projects/terraform-course-lab/infra terraform -c "terraform init"
docker compose run --rm -w /projects/terraform-course-lab/infra terraform -c "terraform apply -auto-approve"
```

## Step 2: Provision Kubernetes Resources
Once the EC2 is up and K3s is running:
```bash
# Init and Apply Apps
docker compose run --rm -w /projects/terraform-course-lab/apps terraform -c "terraform init"
docker compose run --rm -w /projects/terraform-course-lab/apps terraform -c "terraform apply -auto-approve"
```

## Connect to the portal public address
Once everything is provisioned, you can visit the portal by using the public address exposed in the "portal_url" infra output variable.

## Connect to EC2 and Kubernetes
```bash
ssh -i .ssh/terraform-lab ubuntu@[EC2 public IP] <-- This exact instruction is available in the infra output variable ssh_command
sudo kubectl config set-context --current --namespace=rateacharacter
```

## Trigger the Lambda function with the weekly activity
After some activity in the web, you can generate an activity report. It's a weekly report, but you can trigger it manually by:
```bash
docker compose run --rm terraform -c "aws lambda invoke --function-name terraform-aws-lab-reporter --region eu-west-3 response.json"
```
The report will be places in the terraform-aws-lab-assets-xxxxxxx bucket, with a /reports preffix.

## Maintenance
- To update AWS settings, work in `infra/`.
- To update K8s settings, work in `apps/`.
- No more "Connection Refused" errors when updating AWS!

## Clean up
```bash
# Destroy Apps first
docker compose run --rm -w /projects/terraform-course-lab/apps terraform -c "terraform destroy -auto-approve"

# Then Destroy Infra
docker compose run --rm -w /projects/terraform-course-lab/infra terraform -c "terraform destroy -auto-approve"
```
